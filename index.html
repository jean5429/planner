<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weekly Agenda â€” Settings + Theme</title>
  <style>
    :root{
      /* Light theme tokens */
      --bg: #fcfcf9;
      --surface: #ffffff;
      --text: #13343b;
      --muted: #626c71;
      --primary: #21808d;
      --card-border: rgba(94,82,64,0.12);
      --current-time: rgba(245,158,11,0.15);
      --current-time-border: rgba(245,158,11,0.4);
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.04);
    }
    [data-theme="dark"]{
      --bg:#1f2121;
      --surface:#262828;
      --text:#e6e6e6;
      --muted:#a7a9a9;
      --primary:#32b8c6;
      --card-border: rgba(167,169,169,0.12);
      --current-time: rgba(180,83,9,0.2);
      --current-time-border: rgba(245,158,11,0.5);
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.5);
    }

    [data-theme="dark"] .unmerge-btn,
    [data-theme="dark"] .language-option {
      color: var(--text) !important; 
      border-color: rgba(255,255,255,0.08) !important;
    }

    [data-theme="dark"] .icon-btn,
    [data-theme="dark"] .toggle-empty,
    [data-theme="dark"] .btn,
    [data-theme="dark"] .btn-primary {
      color: var(--text) !important;
    }


    :root{
      --space-8:8px; --space-12:12px; --space-16:16px; --space-20:20px; --space-24:24px;
      --radius-base:8px; --font-size-base:14px; --font-size-xl:18px; --duration-fast:150ms;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; font-size:var(--font-size-base); background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;}
    .app-header{background:var(--surface); border-bottom:1px solid var(--card-border); padding:var(--space-16) var(--space-20); position:sticky; top:0; z-index:120; box-shadow:var(--shadow-sm);}
    .header-content{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:var(--space-16);}
    .app-title{font-size:20px;font-weight:600}
    .header-left{display:flex;gap:12px;align-items:center}
    .current-datetime{color:var(--muted);font-size:13px}
    .header-actions{display:flex;gap:12px;align-items:center}
    .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;background:transparent;color:var(--text);font-weight:500;border:1px solid var(--card-border)}
    .btn-primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .icon-btn{display:inline-flex;align-items:center;justify-content:center;padding:8px;border-radius:8px;border:1px solid var(--card-border);background:transparent;cursor:pointer}
    .day-tabs{background:var(--surface); border-bottom:1px solid var(--card-border); position:sticky; top:var(--appHeaderHeight,56px); z-index:115;}
    .day-tabs-container{max-width:1200px;margin:0 auto;display:flex;gap:8px;padding:12px 20px;overflow:auto}
    .day-tab{padding:8px 12px;border-radius:8px;background:transparent;border:1px solid var(--card-border);color:var(--muted);cursor:pointer;white-space:nowrap}
    .day-tab.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    main{max-width:1200px;margin:0 auto;padding:20px;width:100%}
    .schedule-container{background:var(--surface); border-radius:12px; border:1px solid var(--card-border); overflow:visible; position:relative}
    /* schedule-header is sticky (fixed below app header + day tabs) */
    .schedule-header{ padding:16px 20px; background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.9)); border-bottom:1px solid var(--card-border); display:flex;align-items:center;justify-content:space-between; gap:16px; position:sticky; top:0; z-index:110; backdrop-filter: blur(2px);}
    [data-theme="dark"] .schedule-header{ background: linear-gradient(180deg, rgba(40,40,40,0.95), rgba(38,38,38,0.9)); }
    .schedule-left{display:flex;flex-direction:column;gap:6px}
    .schedule-day-name{font-size:var(--font-size-xl); font-weight:600}
    .schedule-now{font-size:12px;color:var(--muted)}
    .schedule-actions{display:flex;gap:8px;align-items:center}
    .toggle-empty{padding:6px 10px;border-radius:8px;border:1px solid var(--card-border);background:transparent;cursor:pointer;color:var(--text)}
    .schedule-grid{padding:20px}
    .time-slot{display:flex;align-items:stretch;border-bottom:1px solid rgba(0,0,0,0.04);min-height:48px;transition:background var(--duration-fast)}
    .time-slot:last-child{border-bottom:none}
    .time-label{width:120px;flex-shrink:0;padding:12px;border-right:1px solid rgba(0,0,0,0.03);color:var(--muted);display:flex;align-items:center}
    .slot-content{flex:1;display:flex;gap:12px;align-items:center;padding:8px 16px;position:relative}
    .slot-input{flex:1;border:0;background:transparent;outline:none;font-size:14px;color:var(--text)}
    .slot-input.checked{opacity:0.6;text-decoration:line-through}
    .slot-checkbox{width:20px;height:20px;flex-shrink:0;cursor:pointer}
    .unmerge-btn{margin-left:auto;padding:6px;border-radius:6px;border:1px solid var(--card-border);background:transparent;cursor:pointer}
    .time-slot.current-time{background:var(--current-time);border-left:3px solid var(--current-time-border);border-right:3px solid var(--current-time-border)}
    .hidden-by-filter{display:none !important}
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:1000}
    .modal-overlay.active{display:flex}
    .modal{background:var(--surface);border-radius:12px;box-shadow:0 10px 20px rgba(0,0,0,0.08);max-width:520px;width:100%;border:1px solid var(--card-border);overflow:hidden}
    .modal-header{padding:16px 20px;border-bottom:1px solid var(--card-border);display:flex;justify-content:space-between;align-items:center}
    .modal-body{padding:20px}
    .modal-footer{padding:12px 20px;border-top:1px solid var(--card-border);display:flex;justify-content:flex-end;gap:8px}
    .form-group{margin-bottom:12px}
    .form-label{display:block;margin-bottom:8px;color:var(--muted);font-size:13px}
    .form-select{width:100%;padding:8px;border-radius:8px;border:1px solid var(--card-border);background:transparent;color:var(--text)}
    .language-selector{display:flex;gap:8px;flex-wrap:wrap}
    .language-option{padding:8px 12px;border-radius:8px;border:1px solid var(--card-border);cursor:pointer;background:transparent}
    @media(max-width:768px){
      .time-label{width:80px;font-size:12px}
      .schedule-header{padding:12px}
    }
  </style>
</head>
<body>
  <!-- App Header -->
  <header class="app-header" id="appHeader">
    <div class="header-content">
      <div class="header-left">
        <h1 class="app-title">Weekly Agenda</h1>
        <div id="currentDateTime" class="current-datetime">â€”</div>
      </div>
      <div class="header-actions">
        <button class="btn" id="btnToday">ğŸ“… Today</button>
        <button class="btn" id="btnSettings">âš™ï¸ Settings</button>
        <button class="icon-btn" id="themeToggle" title="Toggle theme">ğŸŒ“</button>
      </div>
    </div>
  </header>

  <!-- Day Tabs -->
  <nav class="day-tabs" id="dayTabsWrap">
    <div class="day-tabs-container" id="dayTabs"></div>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <div class="schedule-container">
      <div class="schedule-header" id="scheduleHeader">
        <div class="schedule-left">
          <div class="schedule-day-name" id="scheduleDayName">Day</div>
          <div class="schedule-now" id="scheduleCurrentTime">Now: â€”</div>
        </div>
        <div class="schedule-actions">
          <button id="toggleEmptyBtn" class="toggle-empty" title="Toggle empty slots">Hide empty</button>
        </div>
      </div>

      <div class="schedule-grid" id="scheduleGrid"></div>
    </div>
  </main>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <h3 id="modalTitle">Time Range Settings</h3>
        <button id="modalClose" class="icon-btn" title="Close">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label" for="startTime">Start Time</label>
          <select id="startTime" class="form-select"></select>
        </div>
        <div class="form-group">
          <label class="form-label" for="endTime">End Time</label>
          <select id="endTime" class="form-select"></select>
        </div>
        <div class="form-group">
          <div id="timeRangePreview" class="form-label" style="font-weight:500;color:var(--muted);"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Language</label>
          <div id="languageSelector" class="language-selector"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btnCancel" class="btn">Cancel</button>
        <button id="btnSave" class="btn btn-primary">Save Changes</button>
      </div>
    </div>
  </div>

  <script>
    /* -------------------------
       Translations
       ------------------------- */
    const translations = {
      en_US:{ flag:"ğŸ‡ºğŸ‡¸", name:"English (US)", weekdays: {Sunday:"Sunday",Monday:"Monday",Tuesday:"Tuesday",Wednesday:"Wednesday",Thursday:"Thursday",Friday:"Friday",Saturday:"Saturday", Sun:"Sun",Mon:"Mon",Tue:"Tue",Wed:"Wed",Thu:"Thu",Fri:"Fri",Sat:"Sat"}, header:"Weekly Agenda", today:"Today", settings:"Settings", addItem:"Add agenda item...", modalTitle:"Time Configuration", startTime:"Start Time", endTime:"End Time", language:"Language", save:"Save", close:"Close", cancel:"Cancel", timeRangePreview:"Duration: {hours} hours â€¢ {slots} time slots", errorEndTime:"End time must be after start time", errorMinDuration:"Time range must be at least 2 hours", hideEmpty:"Hide empty", showEmpty:"Show empty" },
      pt_BR:{ flag:"ğŸ‡§ğŸ‡·", name:"PortuguÃªs (BR)", weekdays:{Sunday:"Domingo",Monday:"Segunda",Tuesday:"TerÃ§a",Wednesday:"Quarta",Thursday:"Quinta",Friday:"Sexta",Saturday:"SÃ¡bado", Sun:"Dom",Mon:"Seg",Tue:"Ter",Wed:"Qua",Thu:"Qui",Fri:"Sex",Sat:"Sab"}, header:"Agenda Semanal", today:"Hoje", settings:"ConfiguraÃ§Ãµes", addItem:"Adicionar item...", modalTitle:"ConfiguraÃ§Ã£o de HorÃ¡rio", startTime:"Hora de InÃ­cio", endTime:"Hora de TÃ©rmino", language:"Idioma", save:"Salvar", close:"Fechar", cancel:"Cancelar", timeRangePreview:"DuraÃ§Ã£o: {hours} horas â€¢ {slots} intervalos", errorEndTime:"Hora de tÃ©rmino deve ser apÃ³s hora de inÃ­cio", errorMinDuration:"Intervalo de tempo deve ser de pelo menos 2 horas", hideEmpty:"Ocultar vazios", showEmpty:"Mostrar vazios" },
      es_ES:{ flag:"ğŸ‡ªğŸ‡¸", name:"EspaÃ±ol (ES)", weekdays:{Sunday:"Domingo",Monday:"Lunes",Tuesday:"Martes",Wednesday:"MiÃ©rcoles",Thursday:"Jueves",Friday:"Viernes",Saturday:"SÃ¡bado", Sun:"Dom",Mon:"Lun",Tue:"Mar",Wed:"MiÃ©",Thu:"Jue",Fri:"Vie",Sat:"Sab"}, header:"Agenda Semanal", today:"Hoy", settings:"ConfiguraciÃ³n", addItem:"Agregar elemento...", modalTitle:"ConfiguraciÃ³n de Hora", startTime:"Hora de Inicio", endTime:"Hora de Fin", language:"Idioma", save:"Guardar", close:"Cerrar", cancel:"Cancelar", timeRangePreview:"DuraciÃ³n: {hours} horas â€¢ {slots} intervalos", errorEndTime:"La hora de fin debe ser posterior a la hora de inicio", errorMinDuration:"El rango de tiempo debe ser de al menos 2 horas", hideEmpty:"Ocultar vacÃ­os", showEmpty:"Mostrar vacÃ­os" },
      ja_JP:{ flag:"ğŸ‡¯ğŸ‡µ", name:"æ—¥æœ¬èª", weekdays:{Sunday:"æ—¥æ›œæ—¥",Monday:"æœˆæ›œæ—¥",Tuesday:"ç«æ›œæ—¥",Wednesday:"æ°´æ›œæ—¥",Thursday:"æœ¨æ›œæ—¥",Friday:"é‡‘æ›œæ—¥",Saturday:"åœŸæ›œæ—¥", Sun:"æ—¥",Mon:"æœˆ",Tue:"ç«",Wed:"æ°´",Thu:"æœ¨",Fri:"é‡‘",Sat:"åœŸ"}, header:"é€±é–“äºˆå®š", today:"ä»Šæ—¥", settings:"è¨­å®š", addItem:"äºˆå®šã‚’è¿½åŠ ...", modalTitle:"æ™‚é–“è¨­å®š", startTime:"é–‹å§‹æ™‚åˆ»", endTime:"çµ‚äº†æ™‚åˆ»", language:"è¨€èª", save:"ä¿å­˜", close:"é–‰ã˜ã‚‹", cancel:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«", timeRangePreview:"æœŸé–“: {hours}æ™‚é–“ â€¢ {slots}ã‚¹ãƒ­ãƒƒãƒˆ", errorEndTime:"çµ‚äº†æ™‚åˆ»ã¯é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå¾Œã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“", errorMinDuration:"æ™‚é–“ç¯„å›²ã¯æœ€ä½2æ™‚é–“å¿…è¦ã§ã™", hideEmpty:"ç©ºæ ã‚’éš ã™", showEmpty:"ç©ºæ ã‚’è¡¨ç¤º" }
    };

    /* -------------------------
       App State
       ------------------------- */
    let appState = {
      currentDay: new Date().getDay(),
      startTime: '06:00',
      endTime: '22:00',
      agendaData: {},
      checkboxStates: {},
      lastCheckedDate: new Date().toDateString(),
      currentLanguage: 'pt_BR',
      showEmptySlots: true,
      theme: 'light' // 'light' or 'dark'
    };

    /* -------------------------
       Persistence via URL hash
       ------------------------- */
    function loadStateFromStorage(){
      try{
        const hash = window.location.hash.substring(1);
        if(hash){
          const decoded = decodeURIComponent(hash);
          const parsed = JSON.parse(atob(decoded));
          // merge to appState while keeping defaults for missing fields
          appState = Object.assign(appState, parsed);
        }
      }catch(e){
        console.warn('Could not load state from hash', e);
      }
    }
    function saveStateToStorage(){
      try{
        const stateJson = JSON.stringify(appState);
        const encoded = btoa(stateJson);
        window.location.hash = encodeURIComponent(encoded);
      }catch(e){
        console.error('Error saving state', e);
      }
    }

    /* -------------------------
       Utility / i18n
       ------------------------- */
    function t(key){
      const langObj = translations[appState.currentLanguage] || translations['en_US'];
      return langObj[key] || key;
    }

    /* -------------------------
       Time slot generation / helpers
       ------------------------- */
    function generateTimeSlots(){
      const slots=[];
      const [sh, sm] = appState.startTime.split(':').map(Number);
      const [eh, em] = appState.endTime.split(':').map(Number);
      let h = sh, m = sm;
      while(h < eh || (h===eh && m < em)){
        slots.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`);
        m += 30;
        if(m >= 60){ m = 0; h++; }
      }
      return slots;
    }
    function isCurrentTimeSlot(timeStr){
      const now = new Date();
      const [h, m] = timeStr.split(':').map(Number);
      if(now.getHours() === h){
        if(m === 0 && now.getMinutes() < 30) return true;
        if(m === 30 && now.getMinutes() >= 30) return true;
      }
      return false;
    }
    function isPastTimeSlot(timeStr){
      const now = new Date();
      const [h, m] = timeStr.split(':').map(Number);
      if(h < now.getHours()) return true;
      if(h === now.getHours() && m < now.getMinutes()) return true;
      return false;
    }

    /* -------------------------
       Merge detection & rendering helpers
       ------------------------- */
    function calculateMergedSlots(slots){
      const merged = [];
      let i=0;
      while(i < slots.length){
        const timeStr = slots[i];
        const slotKey = `${appState.currentDay}-${timeStr}`;
        const agendaText = (appState.agendaData[slotKey] || '').toString();
        if(!agendaText.trim()){
          merged.push({ startTime: timeStr, endTime: null, slotKeys: [slotKey], duration: 1 });
          i++; continue;
        }
        let consecutiveCount = 1;
        let j = i + 1;
        const slotKeys = [slotKey];
        while(j < slots.length){
          const nextKey = `${appState.currentDay}-${slots[j]}`;
          const nextText = (appState.agendaData[nextKey] || '').toString();
          if(nextText.trim() === agendaText.trim()){
            consecutiveCount++;
            slotKeys.push(nextKey);
            j++;
          } else break;
        }
        let endTime = null;
        if(consecutiveCount > 1){
          const [sh, sm] = timeStr.split(':').map(Number);
          let eh = sh, em = sm + (consecutiveCount * 30);
          while(em >= 60){ em -= 60; eh++; }
          endTime = `${String(eh).padStart(2,'0')}:${String(em).padStart(2,'0')}`;
        }
        merged.push({ startTime: timeStr, endTime, slotKeys, duration: consecutiveCount });
        i = j;
      }
      return merged;
    }

    /* -------------------------
       Unmerge behavior (keep text only in first slot)
       ------------------------- */
    function unmergeSlots(slotKeys, originalText){
      if(!Array.isArray(slotKeys) || slotKeys.length === 0) return;
      const firstKey = slotKeys[0];
      appState.agendaData[firstKey] = originalText;
      for(let i=1;i<slotKeys.length;i++){
        appState.agendaData[slotKeys[i]] = '';
      }
      saveStateToStorage();
      renderSchedule();
      setTimeout(()=>{
        const input = document.querySelector(`.slot-input[data-slot="${firstKey}"]`);
        if(input){ input.focus(); const len = input.value.length; input.setSelectionRange(len, len); }
      }, 60);
    }

    /* -------------------------
       Renderers
       ------------------------- */
    function renderDayTabs(){
      const container = document.getElementById('dayTabs');
      const baseWeek = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
      const today = new Date().getDay();
      container.innerHTML = baseWeek.map((b,i)=>`<button class="day-tab ${i===appState.currentDay?'active':''} ${i===today?'today':''}" data-day="${i}">${translations[appState.currentLanguage].weekdays[b]}</button>`).join('');
      container.querySelectorAll('.day-tab').forEach(btn=>{
        btn.addEventListener('click', ()=>{ appState.currentDay = parseInt(btn.dataset.day,10); saveStateToStorage(); renderDayTabs(); renderSchedule(); });
      });
    }

    function renderSchedule(){
      const grid = document.getElementById('scheduleGrid');
      const dayNameElem = document.getElementById('scheduleDayName');
      const baseWeek = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
      dayNameElem.textContent = translations[appState.currentLanguage].weekdays[baseWeek[appState.currentDay]];

      const slots = generateTimeSlots();
      if(slots.length === 0){
        grid.innerHTML = `<div style="padding:24px;text-align:center;color:var(--muted)">Please configure your time range in settings</div>`;
        return;
      }

      const merged = calculateMergedSlots(slots);
      const todayIndex = new Date().getDay();
      const isTodayView = (appState.currentDay === todayIndex);

      const html = merged.map(m=>{
        const firstKey = m.slotKeys[0];
        const agendaText = (appState.agendaData[firstKey] || '').toString();
        const isCurrent = isTodayView && isCurrentTimeSlot(m.startTime);
        const isPast = isTodayView && isPastTimeSlot(m.startTime);
        const isMerged = m.duration > 1;
        if(!appState.showEmptySlots && !agendaText.trim() && !isCurrent){
          return '';
        }
        const height = isMerged ? `min-height:${m.duration * 48}px;` : '';
        return `
          <div class="time-slot ${isCurrent?'current-time':''} ${isPast?'past-slot':''}" data-time="${m.startTime}" style="${height}">
            <div class="time-label">${m.startTime}${m.endTime ? ` - ${m.endTime}` : ''}</div>
            <div class="slot-content">
              <input type="checkbox" class="slot-checkbox" data-slot="${firstKey}" ${appState.checkboxStates[firstKey] ? 'checked' : ''} ${!isTodayView ? 'disabled' : ''} />
              <input type="text" class="slot-input ${appState.checkboxStates[firstKey] ? 'checked' : ''}" data-slot="${firstKey}" data-merged-slots='${JSON.stringify(m.slotKeys)}' value="${escapeHtml(agendaText)}" placeholder="${translations[appState.currentLanguage].addItem}" />
              ${isMerged && agendaText.trim() ? `<button class="unmerge-btn" data-slot-keys='${JSON.stringify(m.slotKeys)}' data-text="${escapeHtmlAttr(agendaText)}" type="button" title="Unmerge">âœ‚ï¸ Unmerge</button>` : ''}
            </div>
          </div>
        `;
      }).join('');

      grid.innerHTML = html;

      // Attach listeners
      grid.querySelectorAll('.slot-input').forEach(input=>{
        input.addEventListener('input', e=>{
          const key = e.target.dataset.slot;
          appState.agendaData[key] = e.target.value;
          saveStateToStorage();
        });
        input.addEventListener('blur', e=>{
          mergeOnBlur(e.target);
          saveStateToStorage();
        });
      });

      grid.querySelectorAll('.slot-checkbox').forEach(cb=>{
        cb.addEventListener('change', e=>{
          const key = e.target.dataset.slot;
          appState.checkboxStates[key] = e.target.checked;
          const inp = grid.querySelector(`.slot-input[data-slot="${key}"]`);
          if(inp) inp.classList.toggle('checked', e.target.checked);
          saveStateToStorage();
        });
      });

      grid.querySelectorAll('.unmerge-btn').forEach(btn=>{
        btn.addEventListener('click', e=>{
          e.preventDefault(); e.stopPropagation();
          try{
            const keys = JSON.parse(btn.getAttribute('data-slot-keys'));
            const text = btn.getAttribute('data-text');
            unmergeSlots(keys, text);
          }catch(err){ console.error('unmerge error', err); }
        });
      });
    }

    function mergeOnBlur(inputElement){
      // simple approach: saving is enough; calculateMergedSlots will reconstruct merged blocks on render
      const slotKey = inputElement.dataset.slot;
      const txt = (appState.agendaData[slotKey] || '').toString();
      if(!txt.trim()){
        saveStateToStorage();
        renderSchedule();
        return;
      }
      saveStateToStorage();
      renderSchedule();
    }

    /* -------------------------
       Settings Modal: populate selects + language selector + preview + save
       ------------------------- */
    function populateTimeSelects(){
      const startSelect = document.getElementById('startTime');
      const endSelect = document.getElementById('endTime');
      const times = [];
      for(let hour=0; hour<24; hour++){
        for(let min=0; min<60; min+=30){
          times.push(`${String(hour).padStart(2,'0')}:${String(min).padStart(2,'0')}`);
        }
      }
      times.push('24:00');
      startSelect.innerHTML = times.slice(0, -1).map(t => `<option value="${t}">${t}</option>`).join('');
      endSelect.innerHTML = times.map(t => `<option value="${t}">${t}</option>`).join('');
    }

    function updateTimeRangePreview(){
      const start = document.getElementById('startTime').value;
      const end = document.getElementById('endTime').value;
      const [sh, sm] = start.split(':').map(Number);
      const [eh, em] = end.split(':').map(Number);
      let total = (eh * 60 + em) - (sh * 60 + sm);
      if(total < 0) total += 24 * 60;
      const hours = Math.floor(total / 60);
      const slots = Math.floor(total / 30);
      const preview = t('timeRangePreview').replace('{hours}', hours).replace('{slots}', slots);
      document.getElementById('timeRangePreview').textContent = preview;
    }

    function renderLanguageSelector(){
      const container = document.getElementById('languageSelector');
      const languages = ['en_US', 'pt_BR', 'es_ES', 'ja_JP'];
      container.innerHTML = languages.map(lc => {
        const lang = translations[lc];
        return `<button class="language-option" data-lang="${lc}" aria-pressed="${appState.currentLanguage===lc}">${lang.flag} ${lang.name}</button>`;
      }).join('');
      container.querySelectorAll('.language-option').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const lc = btn.dataset.lang;
          appState.currentLanguage = lc;
          saveStateToStorage();
          updateAllTranslations();
          renderLanguageSelector();
        });
      });
    }

    function openSettingsModal(){
      populateTimeSelects();
      document.getElementById('startTime').value = appState.startTime;
      document.getElementById('endTime').value = appState.endTime;
      updateTimeRangePreview();
      renderLanguageSelector();
      document.getElementById('settingsModal').classList.add('active');
      document.getElementById('settingsModal').setAttribute('aria-hidden','false');
    }

    function closeSettingsModal(){
      document.getElementById('settingsModal').classList.remove('active');
      document.getElementById('settingsModal').setAttribute('aria-hidden','true');
    }

    function saveSettings(){
      const start = document.getElementById('startTime').value;
      const end = document.getElementById('endTime').value;
      const [sh, sm] = start.split(':').map(Number);
      const [eh, em] = end.split(':').map(Number);
      const startTotal = sh * 60 + sm;
      const endTotal = eh * 60 + em;
      if(endTotal <= startTotal){
        alert(t('errorEndTime'));
        return;
      }
      if(endTotal - startTotal < 120){
        alert(t('errorMinDuration'));
        return;
      }
      appState.startTime = start;
      appState.endTime = end;
      // language already handled via selector
      saveStateToStorage();
      closeSettingsModal();
      renderSchedule();
    }

    /* -------------------------
       Theme handling
       ------------------------- */
    function applyTheme(){
      document.documentElement.setAttribute('data-theme', appState.theme === 'dark' ? 'dark' : 'light');
      // change icon/title if you want
      const themeBtn = document.getElementById('themeToggle');
      themeBtn.textContent = appState.theme === 'dark' ? 'ğŸŒ™' : 'ğŸŒ“';
    }
    function toggleTheme(){
      appState.theme = appState.theme === 'dark' ? 'light' : 'dark';
      saveStateToStorage();
      applyTheme();
    }

    /* -------------------------
       Toggle empty slots
       ------------------------- */
    function toggleEmptySlots(){
      appState.showEmptySlots = !appState.showEmptySlots;
      const btn = document.getElementById('toggleEmptyBtn');
      btn.textContent = appState.showEmptySlots ? t('hideEmpty') : t('showEmpty');
      saveStateToStorage();
      renderSchedule();
    }

    /* -------------------------
       Time / header positioning helpers
       ------------------------- */
    function updateTimeDisplays(){
      const now = new Date();
      const options = { weekday:'long', year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit' };
      document.getElementById('currentDateTime').textContent = now.toLocaleDateString('en-US', options);
      const nowShort = now.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
      document.getElementById('scheduleCurrentTime').textContent = `${now.toLocaleDateString()} â€¢ ${nowShort}`;
    }

    function updateScheduleHeaderTop(){
      const appHeader = document.getElementById('appHeader');
      const dayTabs = document.querySelector('.day-tabs');
      const scheduleHeader = document.getElementById('scheduleHeader');
      const offset = (appHeader ? appHeader.offsetHeight : 0) + (dayTabs ? dayTabs.offsetHeight : 0);
      scheduleHeader.style.top = offset + 'px';
      document.documentElement.style.setProperty('--appHeaderHeight', `${appHeader ? appHeader.offsetHeight : 56}px`);
    }

    function scrollToCurrentTime(){
      setTimeout(()=>{
        const cur = document.querySelector('.time-slot.current-time');
        if(cur) cur.scrollIntoView({behavior:'smooth', block:'center'});
      }, 120);
    }

    /* -------------------------
       Utility: escape text for HTML/attribute
       ------------------------- */
    function escapeHtml(str){ return (str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
    function escapeHtmlAttr(str){ return (str||'').replace(/"/g,'&quot;').replace(/'/g,"&#39;"); }

    /* -------------------------
       Init + event binding
       ------------------------- */
    function updateAllTranslations(){
      document.querySelector('.app-title').textContent = t('header');
      document.getElementById('btnToday').textContent = `ğŸ“… ${t('today')}`;
      document.getElementById('btnSettings').textContent = `âš™ï¸ ${t('settings')}`;
      document.getElementById('toggleEmptyBtn').textContent = appState.showEmptySlots ? t('hideEmpty') : t('showEmpty');
      renderDayTabs();
      renderSchedule();
      updateTimeRangePreview();
      renderLanguageSelector();
      updateTimeDisplays();
    }

    function setupEventListeners(){
      document.getElementById('btnToday').addEventListener('click', ()=>{
        appState.currentDay = new Date().getDay();
        saveStateToStorage();
        renderDayTabs();
        renderSchedule();
        scrollToCurrentTime();
      });
      document.getElementById('btnSettings').addEventListener('click', openSettingsModal);
      document.getElementById('modalClose').addEventListener('click', closeSettingsModal);
      document.getElementById('btnCancel').addEventListener('click', closeSettingsModal);
      document.getElementById('btnSave').addEventListener('click', saveSettings);
      document.getElementById('startTime').addEventListener('change', updateTimeRangePreview);
      document.getElementById('endTime').addEventListener('change', updateTimeRangePreview);
      document.getElementById('toggleEmptyBtn').addEventListener('click', toggleEmptySlots);
      document.getElementById('themeToggle').addEventListener('click', toggleTheme);
      document.getElementById('settingsModal').addEventListener('click', (e)=>{
        if(e.target.id === 'settingsModal') closeSettingsModal();
      });
      window.addEventListener('resize', updateScheduleHeaderTop);
    }

    function checkAndResetDailyCheckboxes(){
      const today = new Date().toDateString();
      if(appState.lastCheckedDate !== today){
        appState.checkboxStates = {};
        appState.lastCheckedDate = today;
        saveStateToStorage();
      }
    }

    function init(){
      loadStateFromStorage();
      // ensure theme is set early
      if(!['light','dark'].includes(appState.theme)) appState.theme = 'light';
      applyTheme();
      checkAndResetDailyCheckboxes();
      setupEventListeners();
      updateScheduleHeaderTop();
      updateAllTranslations();
      renderDayTabs();
      renderSchedule();
      updateTimeDisplays();
      scrollToCurrentTime();
      // intervals
      setInterval(()=>{ updateTimeDisplays(); renderSchedule(); }, 60000);
    }

    if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();
  </script>
</body>
</html>
